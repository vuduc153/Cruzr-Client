var NAV2D=NAV2D||{REVISION:"0.5.0-SNAPSHOT"};NAV2D.resizeMap=function(e,o,t){return e||(e={width:t.width,height:t.height,x:t.pose.position.x,y:t.pose.position.y},o.scaleToDimensions(t.width,t.height),o.shift(t.pose.position.x,t.pose.position.y)),(e.width!==t.width||e.height!==t.height)&&(o.scaleToDimensions(t.width,t.height),e.width=t.width,e.height=t.height),(e.x!==t.pose.position.x||e.y!==t.pose.position.y)&&(o.shift((t.pose.position.x-e.x)/1,(t.pose.position.y-e.y)/1),e.x=t.pose.position.x,e.y=t.pose.position.y),e},NAV2D.ImageMapClientNav=function(e){var o=(e=e||{}).ros,t=e.tfClient||null,a=e.topic||"/map_metadata",i=e.robot_pose||"/robot_pose",n=e.image_map,r=e.image||!1,s=e.serverName||"/move_base",l=e.actionName||"move_base_msgs/MoveBaseAction",c=e.rootObject||new createjs.Container,g=e.viewer,p=e.withOrientation||!1,h=null,m=e.arrow_size||25,u=new ROS2D.ImageMapClient({ros:o,rootObject:c,topic:a,image:n});this.navigator=new NAV2D.Navigator({ros:o,tfClient:t,serverName:s,actionName:l,robot_pose:i,rootObject:c,withOrientation:p,image:r,arrow_size:m}),u.on("change",function(){h=NAV2D.resizeMap(h,g,u.currentGrid)})},NAV2D.Navigator=function(e){var o,t=this,a=(e=e||{}).ros,i=e.tfClient||null,n=e.robot_pose||"/robot_pose",r=e.serverName||"/move_base",s=e.actionName||"move_base_msgs/MoveBaseAction",l=e.withOrientation||!1,c=e.image,g=e.arrow_size||25;this.rootObject=e.rootObject||new createjs.Container,this.goalMarker=null;var p=new ROSLIB.ActionClient({ros:a,actionName:s,serverName:r});function h(e){var a=new ROSLIB.Goal({actionClient:p,goalMessage:{target_pose:{header:{frame_id:"/map"},pose:e}}});a.send(),t.currentGoal=a,null===t.goalMarker&&(c&&ROS2D.hasOwnProperty("ImageNavigator")?t.goalMarker=new ROS2D.ImageNavigator({size:2.5,image:c,alpha:.7,pulse:!0}):t.goalMarker=new ROS2D.NavigationArrow({size:.6*g,strokeSize:1,fillColor:createjs.Graphics.getRGB(255,64,128,.66),pulse:!0}),t.rootObject.addChild(t.goalMarker)),t.goalMarker.x=e.position.x,t.goalMarker.y=-e.position.y,t.goalMarker.rotation=o.rosQuaternionToGlobalTheta(e.orientation),t.goalMarker.scaleX=1/o.scaleX,t.goalMarker.scaleY=1/o.scaleY,a.on("result",function(){t.rootObject.removeChild(t.goalMarker),t.goalMarker=null})}this.cancelGoal=function(){void 0!==t.currentGoal&&t.currentGoal.cancel()},o=t.rootObject instanceof createjs.Stage?t.rootObject:t.rootObject.getStage();var m=null;(m=c&&ROS2D.hasOwnProperty("ImageNavigator")?new ROS2D.ImageNavigator({size:2.5,image:c,pulse:!0}):new ROS2D.NavigationArrow({size:g,strokeSize:1,fillColor:createjs.Graphics.getRGB(255,128,0,.66),pulse:!0})).visible=!1,this.rootObject.addChild(m);var u=!1,v=function(e,t){m.x=e.x,m.y=-e.y,u||(m.scaleX=1/o.scaleX,m.scaleY=1/o.scaleY,u=!0),m.rotation=o.rosQuaternionToGlobalTheta(t),m.visible=!0};if(null!==i?i.subscribe(n,function(e){v(e.translation,e.rotation)}):new ROSLIB.Topic({ros:a,name:n,messageType:"geometry_msgs/Pose",throttle_rate:100}).subscribe(function(e){v(e.position,e.orientation)}),!1===l)this.rootObject.addEventListener("dblclick",function(e){var t=o.globalToRos(e.stageX,e.stageY);h(new ROSLIB.Pose({position:new ROSLIB.Vector3(t)}))});else{var w=null,b=null,$=0,d=0,N=null,f=!1,O=0,_=0,y=function(e,a){if("down"===a)w=o.globalToRos(e.stageX,e.stageY),b=new ROSLIB.Vector3(w),f=!0;else if("move"===a){if(t.rootObject.removeChild(N),!0===f){var i=o.globalToRos(e.stageX,e.stageY),n=new ROSLIB.Vector3(i);N=c&&ROS2D.hasOwnProperty("ImageNavigator")?new ROS2D.ImageNavigator({size:2.5,image:c,alpha:.7,pulse:!1}):new ROS2D.NavigationArrow({size:g,strokeSize:1,fillColor:createjs.Graphics.getRGB(0,255,0,.66),pulse:!1}),(d=($=Math.atan2(O=n.x-b.x,_=n.y-b.y))*(180/Math.PI))>=0&&d<=180?d+=270:d-=90,N.x=b.x,N.y=-b.y,N.rotation=d,N.scaleX=1/o.scaleX,N.scaleY=1/o.scaleY,t.rootObject.addChild(N)}}else if(f){f=!1;var r=o.globalToRos(e.stageX,e.stageY),s=new ROSLIB.Vector3(r);($=Math.atan2(O=s.x-b.x,_=s.y-b.y))>=0&&$<=Math.PI?$+=3*Math.PI/2:$-=Math.PI/2;var l=Math.sin(-$/2),p=Math.cos(-$/2),m=new ROSLIB.Quaternion({x:0,y:0,z:l,w:p}),u=new ROSLIB.Pose({position:b,orientation:m});h(u)}};this.rootObject.addEventListener("stagemousedown",function(e){y(e,"down")}),this.rootObject.addEventListener("stagemousemove",function(e){y(e,"move")}),this.rootObject.addEventListener("stagemouseup",function(e){y(e,"up")})}},NAV2D.OccupancyGridClientNav=function(e){var o=(e=e||{}).ros,t=e.tfClient||null,a=e.topic||"/map",i=e.robot_pose||"/robot_pose",n=e.continuous,r=e.serverName||"/move_base",s=e.actionName||"move_base_msgs/MoveBaseAction",l=e.rootObject||new createjs.Container,c=e.viewer,g=e.withOrientation||!1,p=e.image||!1,h=null,m=e.arrow_size||25,u=new ROS2D.OccupancyGridClient({ros:o,rootObject:l,continuous:n,topic:a});this.navigator=new NAV2D.Navigator({ros:o,tfClient:t,serverName:r,actionName:s,robot_pose:i,rootObject:l,withOrientation:g,image:p,arrow_size:m}),u.on("change",function(){h=NAV2D.resizeMap(h,c,u.currentGrid)})};